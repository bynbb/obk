<?xml version="1.0" encoding="UTF-8"?>
<gsl-prompt id="20250729T185556-0400">

<gsl-header>

# Bulletproof Pytest Setup

</gsl-header>

<!--
Note: This GSL document uses XML-like section tags as containers, but the content inside each section may include markdown, tables, or other non-XML elements. Strict XML parsing is neither required nor expected; all parsing and automation should be tolerant of mixed content.
-->

<gsl-block>

<gsl-purpose>

## 1.  Purpose

Ensure the obk CLI as a robust implementation of Pytest.   </gsl-purpose>

<gsl-key-input-artifacts>

## 2.  Key Input Artifacts
This table highlights a select set of notable input artifacts that directly influence or constrain the OBK scaffold. Each entry represents a reference or configuration source that is especially relevant for agent workflows, enforcement rules, or architectural conventions. The list is intentionally concise and focuses on materials that meaningfully shape project automation or agent behavior.

| Input Artifact | Notes |
| --- | --- |
| ChatGPT / Codex | Tool |
|  **Why One-Line Manual Tests Should Precede Automation**   | Article    |
|  **Bulletproof Pytest Setup**   | Article    |


</gsl-key-input-artifacts>

<gsl-key-output-components>



## 3. Key Output Components

Below are the key output components generated by the OBK scaffold process. Each component is a distinct, verifiable artifact produced through automation, configuration, or agent-driven workflow. These are the minimum essential pieces required to assemble, deploy, or audit the OBK CLI project.

- add pytest.ini with coverage options
- ignore pytest artifacts
- pytest.ini
- record manual tests for pytest usage
- tests/conftest.py
- tests/test_sample.py


</gsl-output-components>

<gsl-workflow-steps>

## 4.  Workflow Steps

#### Workflow to Use the Upgraded Unit Test Setup



##### 1. **Install Test Dependencies**

The project defines test dependencies in `pyproject.toml` under `[project.optional-dependencies]`:

```toml
[project.optional-dependencies]
test = [
    "pytest >=7.0.0",
    "pytest-cov >=4.0.0",
    "pytest-mock >=3.10.0",
    "python-dotenv >=1.0.0",
]
```

**Install everything needed for testing with:**

```bash
pip install -e ".[test]"
```



##### 2. **Understand the Pytest Configuration**

The `pytest.ini` file is set up to:

* Add `src/` to `PYTHONPATH`
    
* Configure pytest options for coverage and quiet output
    
* Specify the test directory
    

```ini
[pytest]
pythonpath = src
addopts = -ra -q --cov=src --cov-report=term-missing
testpaths = tests
```

**Result:**  
You can run pytest from any directory, without setting extra environment variables.



##### 3. **Run the Test Suite**

**Basic command (from project root):**

```bash
pytest
```

* Runs all tests in `tests/` with coverage enabled (as defined in `pytest.ini`).
    

**Explicit coverage command:**

```bash
pytest --cov=src --cov-report=term-missing
```



##### 4. **Work with Fixtures**

**Define common fixtures in `tests/conftest.py`:**

```python
import pytest

@pytest.fixture
def sample_data():
    return {"foo": 1, "bar": 2}
```

**Use fixtures in your tests:**

```python
def test_sample_fixture(sample_data):
    assert sample_data["foo"] == 1
```



##### 5. **Best Practices & Tips**

* **Project layout:** Keep code in `src/`, tests in `tests/`, and fixtures in `conftest.py`.
    
* **.gitignore:** Make sure `.pytest_cache/` and `.coverage` are ignored.
    
* **CI integration:** Have your CI run `pytest` with coverage flags for consistent results.
    
* **Environment variables:** If you need to load a `.env` file, add `--dotenv=.env` in your `addopts` (requires `python-dotenv`).
    



##### 6. **Summary: Test Workflow**

1. **Install test dependencies:**
    
    ```bash
    pip install -e ".[test]"
    ```
    
2. **Run pytest from the project root:**
    
    ```bash
    pytest
    ```
    
3. **Review coverage output** for missing lines.
    
4. **Integrate these steps in your CI workflow** for consistent, automated test and coverage reporting.
    

</gsl-workflow-steps>
<gsl-next-steps>

## 5.  Next Steps

| ID | Item | State |
| --- | --- | --- |
| N-0 | The **State** column may be `No Action`, `Incomplete`, `In Progress`, or `Completed`  | <!-- N-0 is instructional only --> |
| N-1 | TBD | Incomplete |

</gsl-next-steps>
<gsl-tdd>

## 6. Tests

#### Setup

```powershell
pip install -e .[test]
```


<gsl-test id="T1">

- T1: `pytest` runs the entire test suite with coverage

</gsl-test>
<gsl-test id="T2">

- T2: `pytest -q` in quiet mode

</gsl-test>
<gsl-test id="T3">

- T3: `pytest --help` displays usage information

</gsl-test>
<gsl-test id="T4">

- T4: `pytest --cov=src --cov-report=term-missing -q`

</gsl-test>
<gsl-test id="T5">

- T5: `.gitignore`
    - Linux / Mac: `grep -q '\.pytest_cache/' .gitignore`
    - PowerShell
        ```powershell
        $pattern = '.pytest_cache/'
        $file = '.gitignore'
        
        if (Select-String -Pattern $pattern -Path $file -SimpleMatch -Quiet) {
            Write-Host "PASS: '$pattern' is present in $file."
        } else {
            Write-Host "FAIL: '$pattern' is NOT present in $file."
        }

        ```
</gsl-test>
<gsl-test id="T6">

- T6: `python -m obk hello-world`

</gsl-test>

<gsl-test id="T7">

- T7: `cat pytest.ini` shows `pythonpath = src`

</gsl-test>

<gsl-test id="T8">

- T8: `cat pytest.ini` contains `--cov=src`

</gsl-test>

<gsl-test id="T9">

- T9: 
    
    - Mac / Linux `grep -A3 "\[project.optional-dependencies\]" pyproject.toml` lists pytest packages
    - PowerShell
    ```powershell
    # Print the line matching '[project.optional-dependencies]' and the 3 lines that follow
    $lines = Get-Content pyproject.toml
    $index = $lines.IndexOf('[project.optional-dependencies]')
    if ($index -ge 0) {
        $lines[$index..([math]::Min($index+3, $lines.Length-1))]
    } else {
        Write-Host "'[project.optional-dependencies]' section not found."
    }

    ```

</gsl-test>

</gsl-tdd>

<gsl-notes>

## 7.  Notes


* N/A

</gsl-notes>

<gsl-specification>

## 8. Grit Structured Language (GSL) Specification

#### Overview

GSL is a structured annotation language for prompt engineering, testing, and traceability. This document defines how agents must maintain and interpret GSL documents, including rules for updating, and validating key sections.

GSL documents use XML-like section tags as containers, but allow markdown, tables, and other non-XML content within these sections. Parsing and automation are expected to handle this mixed-content structure, rather than rely on strict XML validation.


This specification applies to the prompt with ID <gsl-prompt-id>`20250729T185556-0400`</gsl-prompt-id> located at <gsl-deterministic-path>`prompts/07/29/20250729T185556-0400.md`</gsl-deterministic-path>.

#### S-1 Identifier and Numbering Convention

All major structural elements (such as specification sections and requirements, manual test cases, and similar entities) **MUST** be identified by a hierarchical ID in the format **PREFIX-X** for top-level items, **PREFIX-X.Y** for sub-items, and **PREFIX-X.Y.Z** for further nesting, where **PREFIX** is an uppercase letter code (e.g., S for Specification, T for Test, N for Next Steps), and X, Y, Z are integers incremented sequentially.

* For specification sections, the prefix **MUST** be `S` (e.g., S-23).
* For manual test cases (such as under `<gsl-tdd>`), the prefix **MUST** be `T` (e.g., T-1.2).
* For next steps entries (such as within `<gsl-next-steps>`), the prefix **MUST** be `N` (e.g., N-1.1).
* Other prefixes **MAY** be defined for future element categories as needed. 
* Numbering **MUST** be consistent, reflect the document hierarchy, and be incremented without skipping numbers within each parent item.
* These structured IDs **MUST** be used for all references, compliance assertions, traceability, and change tracking.
* Agents and maintainers **MUST NOT** modify or remove existing structured IDs except to correct errors or update structure as specified in approved changes.

#### S-2 Purpose

The purpose of this specification is to:

* Enable deterministic updates to structured prompt files.
* Provide automated and manual mechanisms for auditing and maintaining development intent.
* Define minimal but sufficient constructs for command, testing, and documentation workflows.

#### S-3 Prompt Updates

S-3.0 The following rules apply to automated changes made by agents, not to manual edits performed by human maintainers (even if such edits use AI assistance or suggestions).

S-3.1 Agents **MAY ONLY** make changes to the following elements:

* The `<gsl-workflow-steps>` section (agents may modify any part, or the entire section, as necessary. Edits may add, remove, or update individual workflow steps as required).
    
* The **State** column in the `<gsl-next-steps>` table (values may be updated to reflect current status).
    
* **Agents may add new `<gsl-test>` elements to any `<gsl-tdd>` section. However, once a `<gsl-test>` is added, agents may not modify or remove it.**
    

S-3.2 Agents **MUST NOT** modify or remove any other sections or content within the GSL document, including but not limited to:

* `<gsl-purpose>`
    
* `<gsl-key-input-artifacts>`
    
* `<gsl-key-output-components>`
    
* The structure or content (except State) of `<gsl-next-steps>`
    
* `<gsl-notes>`
    
* `<gsl-specification>`
    
* `<gsl-tdd>` (except as allowed above—agents may add new `<gsl-test>` elements but may not modify or remove any `<gsl-test>` element once it is present)
    

S-3.3 Manual edits by maintainers **MAY** update any section as required.

S-3.4 These restrictions ensure the integrity of the specification, audit trails, and test cases, while allowing agents to manage workflow steps, update next-step progress, and contribute new tests without mutating established test records.

#### S-4 `<gsl-next-steps>`

S-4.1 This table **MUST** enumerate pending, current, or completed maintenance actions.

S-4.2 Each entry **MUST** reflect a real or planned repository change.

S-4.3 Entries MAY be removed when obsolete, or modified to reflect new details.

S-4.4 This table **MUST** be consulted prior to making any change.


### **Replacement for S-5 `<gsl-tdd>` Section**

#### S-5 `<gsl-tdd>`

S-5.1 A `<gsl-tdd>` is a container element that holds a collection of `<gsl-test>` child elements.

S-5.2 Each `<gsl-test>` MUST be a single line and MUST carry an `id` attribute in the format `T1`, `T2`, ...

S-5.3 `<gsl-tdd>` elements MAY group related tests, organize audit traces, or partition test concerns.

S-5.4 **Agents may add new `<gsl-test>` elements to any `<gsl-tdd>` section. Once a `<gsl-test>` is added, it may not be modified or removed by any agent. Only maintainers may modify or remove existing `<gsl-test>` elements.**

S-5.5 Manual tests MAY be used for auditing, traceability, and qualitative assessment.


#### S-6 Prompt Supersession

S-6.1 The `<gsl-prompt>` MAY include a `replaced-by` attribute.

S-6.2 This attribute references the **ID of the prompt that replaces the current one**.

Example:

```xml
<gsl-prompt id="20250727T004356-0400" replaced-by="20260727T004356-0400">
```

S-6.3 This allows agents to detect prompt lineage and manage document supersession correctly.

#### S-7 Scope of the Prompt

S-7.1 A prompt is **NOT** an exhaustive specification of all possible behavior.

S-7.2 It does **NOT** attempt to list all inputs, outputs, or steps.

S-7.3 It serves a **traceable, auditable**, and **pragmatic** documentation role within an evolving software system.

S-7.4 Brevity, determinism, and change-tracking are prioritized over completeness.

#### S-8 Workflow Step Formatting

S-8.1 Each workflow step section **MUST** be prefixed by a heading (e.g., `#### 1. Setup`) that indicates the major phase or task group.

S-8.2 Each step within a section **MUST** be formatted as a numbered item, following the pattern:

* `[Section].[Step] Description`,  
    e.g., `1.1 Lorem ipsum dolor sit amet`
    

S-8.3 Nested steps **MAY** be included and MUST follow the format:

* `[Section].[Step].[Substep] Description`,  
    e.g., `2.2.1 Cras justo odio, dapibus ac facilisis in, egestas eget quam`
    

S-8.4 Steps **MUST** be presented as markdown list items (using `-`), e.g.:

```
- 1.1 Lorem ipsum dolor sit amet  
- 1.2 Consectetur adipiscing elit  
```

S-8.5 The style and indentation of workflow steps **MUST** match the following example for clarity and future-proofing:

```markdown
#### 1. Setup

- 1.1 Lorem ipsum dolor sit amet  
- 1.2 Consectetur adipiscing elit  

#### 2. Project Scaffold

- 2.1 Nullam id dolor id nibh ultricies vehicula ut id elit  
- 2.2 Etiam porta sem malesuada magna mollis euismod  
    - 2.2.1 Cras justo odio, dapibus ac facilisis in, egestas eget quam  
- 2.3 Fusce dapibus, tellus ac cursus commodo  
```

S-8.6 Consistent application of this convention is REQUIRED for all `<gsl-workflow-steps>` sections to ensure reliable parsing, readability, and change tracking.

#### S-9 `<gsl-next-steps>` Table Formatting and Policy

S-9.1 The `<gsl-next-steps>` section **MUST** contain a markdown table with exactly three columns: `ID`, `Item`, and `State`—in that order.

S-9.2 The `ID` column **MUST** use the format `N-X`, where `X` is a non-negative integer, incrementing sequentially with no gaps.

S-9.3 The `State` column **MUST** be one of: `No Action`, `Incomplete`, `In Progress`, or `Completed`.

* Instructional or placeholder rows are permitted (e.g., `N-0`) and must use this reserved slot.
    

S-9.4 Each row **MUST** describe a single atomic action or explicit documentation item.

S-9.5 The table **MUST NOT** contain any additional columns or change the column order without explicit specification change.

S-9.6 Completed or obsolete rows **MAY** be removed by maintainers as appropriate.

S-9.7 The table **MUST** use standard markdown table syntax.

S-9.8 Only standard markdown table syntax is supported for the `<gsl-next-steps>` section. HTML tables or any non-standard markdown table formats are not permitted. Tables must be properly aligned and conform to markdown table rules to ensure reliable parsing and automation.

S-9.9 Rows with ID `N-0` are reserved for instructional or placeholder purposes only. These rows must not be interpreted or acted upon as real tasks by agents or maintainers.

</gsl-specification>
</gsl-block>
</gsl-prompt>

