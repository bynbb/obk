TODO: automate delete `next`

# How to Automate Updating `pyproject.toml` Version After Release (with GitHub Actions, No Extra Tools)

Keeping the version in your `pyproject.toml` in sync with your latest release is essential for reproducibility and clarity. However, if you use branch protection on `main`, you can't push changes directly—even automated ones. The solution is to automate the version bump **by opening a pull request** after your release. Here’s how to do it with just GitHub Actions, bash, and Python.

* * *

## **Why Do This?**

* **Keeps `pyproject.toml` version always up-to-date with your latest release.**
    
* **Works with branch protection:** No direct pushes to `main`, only PRs.
    
* **No extra dependencies or bots required—just bash, Python, and GitHub Actions.**
    

* * *

## **Workflow Overview**

1. **After a release/tag is created on `main`,**
    
2. **GitHub Actions workflow runs:**
    
    * Checks out `main`
        
    * Reads the latest tag/version
        
    * Updates the `pyproject.toml` version field
        
    * Commits and pushes the change to a new branch
        
    * Opens a PR to `main` (which can be auto-merged or reviewed)
        

* * *

## **Step-by-Step Setup**

### **1. Ensure the GitHub CLI (`gh`) is Available**

`gh` comes pre-installed on GitHub Actions runners.  
(If you use another CI: install it before running the PR command.)

* * *

### **2. Add the GitHub Actions Workflow**

**File:** `.github/workflows/bump-version.yml`

```yaml
name: Post-release: Bump pyproject.toml Version

on:
  push:
    tags:
      - 'v*.*.*'         # Triggers on new version tags like v1.2.3

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get version from tag
        id: get_tag
        run: |
          TAG=${GITHUB_REF##*/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update pyproject.toml version
        run: |
          VERSION="${{ steps.get_tag.outputs.version }}"
          python3 -c "
import toml
py = 'pyproject.toml'
d = toml.load(py)
d['project']['version'] = '${VERSION}'
toml.dump(d, open(py, 'w'))
"

      - name: Create version bump branch
        run: |
          git checkout -b bump-version/v${{ steps.get_tag.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "chore: bump version to v${{ steps.get_tag.outputs.version }}"
          git push origin bump-version/v${{ steps.get_tag.outputs.version }}

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --title "chore: bump version to v${{ steps.get_tag.outputs.version }}" \
            --body "Automated version bump after release." \
            --head bump-version/v${{ steps.get_tag.outputs.version }} \
            --base main
```

* * *

### **3. How It Works**

* **Trigger:** Runs after you create and push a new tag like `v1.2.3` to `main`.
    
* **Updates:** Sets the `version` field in `pyproject.toml` to `1.2.3`.
    
* **Branches:** Commits this change to a new branch (e.g., `bump-version/v1.2.3`).
    
* **Pull Request:** Opens a PR back to `main` for review and merging (required by branch protection).
    
* **Fully Automated:** No manual steps after tagging/releasing.
    

* * *

### **4. Optional: Handle Multiple Files**

If you need to bump versions in **other files** (like `setup.cfg`, or docs), just add more `python` or `sed` steps before the commit.

* * *

### **5. Dependencies**

* Uses only `python3`, the [`toml`](https://pypi.org/project/toml/) library (included on GitHub runners), and `gh` CLI.
    
* Works with any standard `pyproject.toml` layout.
    

* * *

## **FAQ**

**Q: Can this PR auto-merge?**  
A: Yes! You can set up GitHub branch protection or bot rules to auto-merge trusted PRs from your workflow/bot user.

**Q: Does this replace manual version bumping?**  
A: Yes, for releases. For pre-releases or feature development, you may still bump manually as needed.

**Q: Can I trigger this only for certain tags?**  
A: Adjust the `tags:` pattern in the workflow trigger as needed.

* * *

## **Summary Table**

| Step | What Happens |
| --- | --- |
| Tag a new release | Triggers workflow on main |
| Bump version in pyproject.toml | Branch, commit, and PR is created |
| Merge PR to main | Main is now fully up-to-date |

* * *

## **References**

* GitHub Actions: Using the GitHub CLI (`gh`)
    
* Keep a Changelog
    
* Semantic Versioning
    

* * *

**Now your `pyproject.toml` will always match your latest release, your branch protection rules are respected, and your workflow stays fully automated and auditable—no extra tools needed!**

* * *